<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>openLCA ç¢³æ’æƒ…å¢ƒæ¯”è¼ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c7744;
            --secondary-color: #4a9c66;
            --accent-color: #d4edda;
            --bg-color: #f4f7f6;
            --text-color: #333;
            --danger-color: #dc3545;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 30px 20px;
            margin: 0;
        }

        h2, h3 {
            text-align: center;
            color: var(--primary-color);
        }

        .main-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
        }

        /* æ¯”è¼ƒå€å¡Šçš„ä½ˆå±€ */
        .comparison-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 30px;
        }

        .scenario-box {
            flex: 1 1 400px; /* æ¯å€‹å€å¡Šè‡³å°‘ 400px å¯¬ï¼Œä¸¦å¹³å‡åˆ†é…ç©ºé–“ */
            border: 2px solid #eee;
            padding: 25px;
            border-radius: 12px;
            background-color: #fafafa;
            transition: border-color 0.3s;
        }
        
        .scenario-box:focus-within {
            border-color: var(--secondary-color);
        }

        .scenario-box h3 {
            margin-top: 0;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9em;
            color: #555;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .compare-btn-container {
            text-align: center;
            margin: 30px 0;
        }

        #compareBtn {
            padding: 15px 40px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s, transform 0.1s;
            box-shadow: 0 4px 15px rgba(44, 119, 68, 0.3);
        }

        #compareBtn:hover {
            background-color: #1e5230;
            transform: translateY(-2px);
        }
        
        #compareBtn:active {
            transform: translateY(1px);
        }
        
        #compareBtn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* çµæœé¡¯ç¤ºå€åŸŸ */
        #resultSection {
            display: none; /* é è¨­éš±è— */
            margin-top: 40px;
            border-top: 3px dashed #eee;
            padding-top: 30px;
        }

        .chart-container {
            position: relative;
            height: 400px; /* å›ºå®šåœ–è¡¨é«˜åº¦ */
            width: 100%;
            margin-bottom: 30px;
        }

        #summaryBox {
            background-color: var(--accent-color);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            font-size: 1.2em;
        }
        
        .highlight-reduction {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 1.5em;
        }

        .highlight-increase {
            color: var(--danger-color);
            font-weight: bold;
            font-size: 1.5em;
        }
    </style>
</head>
<body>

<div class="main-container">
    <h2>âš–ï¸ ç¢³æ’æƒ…å¢ƒæ¯”è¼ƒåˆ†æ</h2>
    <p style="text-align: center; color: #666;">è¼¸å…¥å…©å€‹ä¸åŒæƒ…å¢ƒçš„åƒæ•¸ï¼Œæ¯”è¼ƒå…¶ GWP 100 (å…¬æ–¤äºŒæ°§åŒ–ç¢³ç•¶é‡) å·®ç•°ã€‚</p>
    
    <div class="comparison-wrapper">
        <div class="scenario-box" style="border-top: 4px solid var(--secondary-color);">
            <h3>ğŸ“‹ æƒ…å¢ƒ A (åŸºæº–)</h3>
            <div class="form-group">
                <label for="dist_a">é‹è¼¸è·é›¢ (Distance)</label>
                <input type="number" id="dist_a" value="100" required>
            </div>
            <div class="form-group">
                <label for="fact_a">ä¿‚æ•¸ (Factor)</label>
                <input type="number" id="fact_a" value="0.8" required>
            </div>
            <div class="form-group">
                <label for="load_a">è² è¼‰é‡ (Load)</label>
                <input type="number" id="load_a" value="20" required>
            </div>
            <div class="form-group">
                <label for="amt_a">æ•¸é‡ (Amount)</label>
                <input type="number" id="amt_a" value="500" required>
            </div>
        </div>

        <div class="scenario-box" style="border-top: 4px solid #3498db;">
            <h3>ğŸ“‹ æƒ…å¢ƒ B (å°ç…§)</h3>
            <div class="form-group">
                <label for="dist_b">é‹è¼¸è·é›¢ (Distance)</label>
                <input type="number" id="dist_b" value="80" required>
            </div>
            <div class="form-group">
                <label for="fact_b">ä¿‚æ•¸ (Factor)</label>
                <input type="number" id="fact_b" value="0.6" required>
            </div>
            <div class="form-group">
                <label for="load_b">è² è¼‰é‡ (Load)</label>
                <input type="number" id="load_b" value="25" required>
            </div>
            <div class="form-group">
                <label for="amt_b">æ•¸é‡ (Amount)</label>
                <input type="number" id="amt_b" value="500" required>
            </div>
        </div>
    </div>

    <div class="compare-btn-container">
        <button id="compareBtn">ğŸš€ é–‹å§‹åˆ†ææ¯”è¼ƒ</button>
    </div>

    <div id="resultSection">
        <div class="chart-container">
            <canvas id="comparisonChart"></canvas>
        </div>
        <div id="summaryBox">
            </div>
    </div>
</div>

<script>
    // å®šç¾© API URL
    const API_URL = 'http://localhost:5010/calculate';
    
    // ç”¨æ–¼å­˜å„² Chart.js å¯¦ä¾‹çš„å…¨åŸŸè®Šæ•¸ï¼Œä»¥ä¾¿ç¨å¾ŒéŠ·æ¯€é‡å»º
    let myChart = null;

    // è¼”åŠ©å‡½å¼ï¼šå¾ API å›å‚³è³‡æ–™ä¸­æå– 'IPCC 2021 GWP 100' çš„æ•¸å€¼
    function extractGWP100(data) {
        if (!data || data.status !== 'ok' || !data.impacts) return 0;
        const gwpImpact = data.impacts.find(item => item.category.includes('GWP 100'));
        return gwpImpact ? gwpImpact.value : 0;
    }

    // è¼”åŠ©å‡½å¼ï¼šç²å–æŒ‡å®šæƒ…å¢ƒçš„è¼¸å…¥è³‡æ–™
    function getPayload(scenarioSuffix) {
        return {
            distance: Number(document.getElementById(`dist_${scenarioSuffix}`).value),
            factor: Number(document.getElementById(`fact_${scenarioSuffix}`).value),
            load: Number(document.getElementById(`load_${scenarioSuffix}`).value),
            amount: Number(document.getElementById(`amt_${scenarioSuffix}`).value)
        };
    }

    document.getElementById('compareBtn').addEventListener('click', async function() {
        const btn = this;
        const resultSection = document.getElementById('resultSection');
        const summaryBox = document.getElementById('summaryBox');
        
        // 1. è¨­å®š UI ç‹€æ…‹
        btn.disabled = true;
        btn.innerHTML = 'âš™ï¸ åˆ†æè¨ˆç®—ä¸­...';
        resultSection.style.display = 'none';

        try {
            // 2. æº–å‚™å…©å€‹è«‹æ±‚çš„ Payload
            const payloadA = getPayload('a');
            const payloadB = getPayload('b');

            // 3. ä¸¦è¡Œç™¼é€å…©å€‹è«‹æ±‚ (ä½¿ç”¨ Promise.all)
            // é€™æœƒåŒæ™‚ç™¼é€è«‹æ±‚ï¼Œä¸¦ç­‰å¾…å…©è€…éƒ½å®Œæˆ
            const [responseA, responseB] = await Promise.all([
                fetch(API_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payloadA) 
                }),
                fetch(API_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payloadB) 
                })
            ]);

            if (!responseA.ok || !responseB.ok) {
                throw new Error('å…¶ä¸­ä¸€å€‹ API è«‹æ±‚å¤±æ•—');
            }

            const dataA = await responseA.json();
            const dataB = await responseB.json();

            // 4. æå–æ•¸æ“š
            const valA = extractGWP100(dataA);
            const valB = extractGWP100(dataB);

            // 5. é¡¯ç¤ºçµæœå€åŸŸ
            resultSection.style.display = 'block';
            
            // --- ç¹ªè£½åœ–è¡¨ ---
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            // å¦‚æœèˆŠåœ–è¡¨å­˜åœ¨ï¼Œå…ˆéŠ·æ¯€å®ƒ
            if (myChart) {
                myChart.destroy();
            }
            
            myChart = new Chart(ctx, {
                type: 'bar', // é•·æ¢åœ–
                data: {
                    labels: ['æƒ…å¢ƒ A (åŸºæº–)', 'æƒ…å¢ƒ B (å°ç…§)'],
                    datasets: [{
                        label: 'ç¢³æ’æ”¾é‡ (kg CO2 eq - GWP 100)',
                        data: [valA, valB],
                        backgroundColor: [
                            'rgba(46, 125, 50, 0.7)', // A çš„é¡è‰² (æ·±ç¶ )
                            'rgba(52, 152, 219, 0.7)'  // B çš„é¡è‰² (è—è‰²)
                        ],
                        borderColor: [
                            'rgba(46, 125, 50, 1)',
                            'rgba(52, 152, 219, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8, // åœ“è§’é•·æ¢
                        barPercentage: 0.6 // èª¿æ•´é•·æ¢å¯¬åº¦
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'kg CO2 eq'
                            },
                            grid: {
                                color: '#eee'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // éš±è—åœ–ä¾‹ï¼Œå› ç‚ºåªæœ‰ä¸€å€‹ç³»åˆ—
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` ${context.formattedValue} kg CO2 eq`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeOutQuart'
                    }
                }
            });

            // --- è¨ˆç®—ä¸¦é¡¯ç¤ºçµè«–æ‘˜è¦ ---
            let summaryHtml = '';
            const diff = Math.abs(valA - valB);
            const formattedDiff = diff.toFixed(2);

            if (valA > valB) {
                summaryHtml = `
                    <h3>ğŸ‰ çµè«–ï¼šæƒ…å¢ƒ B è¼ƒç‚ºç’°ä¿</h3>
                    <p>ç›¸è¼ƒæ–¼åŸºæº–æƒ…å¢ƒ Aï¼Œæ¡ç”¨æƒ…å¢ƒ B å¯æ¸›å°‘</p>
                    <div class="highlight-reduction">â–¼ ${formattedDiff} kg CO2 eq</div>
                    <p>çš„ç¢³æ’æ”¾é‡ã€‚</p>
                `;
            } else if (valB > valA) {
                summaryHtml = `
                    <h3>âš ï¸ çµè«–ï¼šæƒ…å¢ƒ B ç¢³æ’è¼ƒé«˜</h3>
                    <p>ç›¸è¼ƒæ–¼åŸºæº–æƒ…å¢ƒ Aï¼Œæƒ…å¢ƒ B æœƒå¢åŠ </p>
                    <div class="highlight-increase">â–² ${formattedDiff} kg CO2 eq</div>
                    <p>çš„ç¢³æ’æ”¾é‡ã€‚å»ºè­°ç¶­æŒæƒ…å¢ƒ Aã€‚</p>
                `;
            } else {
                summaryHtml = `
                    <h3>âš–ï¸ çµè«–ï¼šå…©è€…ç¢³æ’ç›¸åŒ</h3>
                    <p>å…©å€‹æƒ…å¢ƒçš„è¨ˆç®—çµæœæ²’æœ‰å·®ç•°ã€‚</p>
                `;
            }
            summaryBox.innerHTML = summaryHtml;

            // æ»¾å‹•åˆ°çµæœå€
            resultSection.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            console.error('Error:', error);
            alert('è¨ˆç®—éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Flask Server æ˜¯å¦æ­£å¸¸é‹ä½œï¼Œä¸¦ç¢ºä¿ CORS å·²å•Ÿç”¨ã€‚');
        } finally {
            // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
            btn.disabled = false;
            btn.innerHTML = 'ğŸš€ é–‹å§‹åˆ†ææ¯”è¼ƒ';
        }
    });
</script>

</body>
</html>